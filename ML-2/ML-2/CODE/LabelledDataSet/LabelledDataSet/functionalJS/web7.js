ISQ.Protocol.WidgetClient=ISQ.Protocol.ClientBase.extend({name:"ISQ.Protocol.WidgetClient"});ISQ.Protocol.WidgetClient.enumRequestType={SENDQUERY:1,THUMBUP:2,ESCALATE:3,CONTACTFORM:4};ISQ.Protocol.WidgetClient.sessionIdKey="sid";ISQ.Protocol.WidgetClient.prototype.initBase=function(a){};ISQ.Protocol.WidgetClient.prototype.ctor=function(a){this.mPageUrl=a.referer||"";this.mAccount=a.account||"";this.mEnableStats=a.enableStats!==false;this.mPageId=a.pageId||null;this.mRequestedKb=a.requestedKb||null;this.mIsAnonymous=true;this.mContexts=a.contexts||null;this.mDoctype=a.doctype||"";this.mConfigId=a.configId||"";if(this.mAccount===""){throw ("Protocol WidgetClient ctor: missing account")}this.mUsername=a.username||"";this.mPassword=a.password||"";if(this.mUsername!==""){this.mIsAnonymous=false}this.mSaveInitCode=false;return this};ISQ.Protocol.WidgetClient.prototype.dtor=function(){this.logoutTimerStop()};ISQ.Protocol.WidgetClient.prototype.closeSession=function(){if(this.connected()){this.sendCloseSessionRequest();this.connectionStateChanged(ISQ.Protocol.connectionStateEnum.DISCONNECTED);this.mContextsSentToServer=false}};ISQ.Protocol.WidgetClient.prototype.connected=function(){return this.mState===ISQ.Protocol.connectionStateEnum.CONNECTED};ISQ.Protocol.WidgetClient.prototype.context=function(){return this.mContexts};ISQ.Protocol.WidgetClient.prototype.contextAsKeyValuePairs=function(){var a=[];if(this.mContexts){for(var b in this.mContexts){a.push({key:b,value:this.mContexts[b]})}}return a};ISQ.Protocol.WidgetClient.prototype.hasContext=function(){if(this.mContexts){for(var a in this.mContexts){return true}}return false};ISQ.Protocol.WidgetClient.prototype.saveSessionForResume=function(a,b){a.widgetSessionId=this.mSessionId;a.now=new Date().getTime();a.logoutTimeout=this.mLogoutTimeout-(2*this.mOpenConnectionInterval);a.account=this.mAccount;var c=ISQ.Data.jsonToString(a);if(!b||!ISQ.Tools.Storage.set(ISQ.Protocol.WidgetClient.sessionIdKey,c,true)){ISQ.Http.Cookies._write(ISQ.Protocol.WidgetClient.sessionIdKey,c,"/widget",ISQ.Http.domain())
}};ISQ.Protocol.WidgetClient.prototype.deleteSessionFromResume=function(a){ISQ.Tools.Storage.remove(ISQ.Protocol.WidgetClient.sessionIdKey,true);ISQ.Http.Cookies._delete(ISQ.Protocol.WidgetClient.sessionIdKey,"/widget",ISQ.Http.domain())};ISQ.Protocol.WidgetClient.prototype.restoreSession=function(){var obj={result:false};if(this.mState===ISQ.Protocol.connectionStateEnum.CONNECTED||this.mState===ISQ.Protocol.connectionStateEnum.CONNECTING||this.mState===ISQ.Protocol.connectionStateEnum.RECONNECTING){return obj}var data=ISQ.Tools.Storage.get(ISQ.Protocol.WidgetClient.sessionIdKey,true);if(!data){data=ISQ.Http.Cookies._read(ISQ.Protocol.WidgetClient.sessionIdKey);if(data){data=unescape(data)}}if(!data){return obj}if(data.length<3){return obj}var json=null;try{json=eval("("+data+")")}catch(e){}if(!json){return obj}if(json.account!=this.mAccount){return obj}ISQ.Http.Cookies._delete(ISQ.Protocol.WidgetClient.sessionIdKey,"/widget",ISQ.Http.domain());if(!json.now){return obj}var now=new Date().getTime();this.mLogoutTimeout=parseInt(json.logoutTimeout);if(now-json.now>this.mLogoutTimeout){return obj}this.mResumeSessionId=json.widgetSessionId;this.login();json.result=true;return json};ISQ.Protocol.WidgetClient.prototype.mIsAnonymous=true;ISQ.Protocol.WidgetClient.prototype.mPageUrl="";ISQ.Protocol.WidgetClient.prototype.mLogoutTimeout=-1;ISQ.Protocol.WidgetClient.prototype.mLogoutTimer=null;ISQ.Protocol.WidgetClient.prototype.mQueries=0;ISQ.Protocol.WidgetClient.prototype.mFailedDataRequests=0;ISQ.Protocol.WidgetClient.prototype.mResumeSessionId=0;ISQ.Protocol.WidgetClient.prototype.mMaxFailedDataRequests=3;ISQ.Protocol.WidgetClient.prototype.mPageId=null;ISQ.Protocol.WidgetClient.prototype.mRequestedKb=null;ISQ.Protocol.WidgetClient.prototype.mContexts=null;ISQ.Protocol.WidgetClient.prototype.mContextsSentToServer=false;ISQ.Protocol.WidgetClient.prototype.mDoctype="";ISQ.Protocol.WidgetClient.prototype.mConfigId;ISQ.Protocol.WidgetClient.prototype.onConnectionStateChanged=function(){if(this.mState!==ISQ.Protocol.connectionStateEnum.CONNECTED){this.logoutTimerStop();
this.mContextsSentToServer=false}else{if(this.mState===ISQ.Protocol.connectionStateEnum.CONNECTED){this.sendContextAndFormValues();var c=this.mAjax.queue.dequeue();var a=[];while(c){a.push(c);c=this.mAjax.queue.dequeue()}var b=this;iteration(a,function(d){b.stripToDataAndSend({data:d.mData,token:d.mToken,timeout:d.mTimeout})})}}};ISQ.Protocol.WidgetClient.prototype.onLogin=function(){if(arguments.length===0){return}this.mServerLog.initialize(arguments[0]);this.mLogoutTimeout=arguments[1]*1000;this.logoutTimerRestart();return null};ISQ.Protocol.WidgetClient.prototype.createLoginRequest=function(){var a=new Array();a.push("<?xml version='1.0' encoding='UTF-8' ?><nR>");if(!this.mIsAnonymous){a.push("<Login username='");a.push(this.fullUsername());a.push("' password='");a.push(this.mPassword);a.push("' keepLoggedIn='false' initCode='");a.push(this.mInitCode);if(this.mResumeSessionId){a.push(" resumeId='");a.push(this.mResumeSessionId);a.push("'")}a.push(" >")}else{a.push("<Login anonymous='true' ");if(this.mResumeSessionId){a.push(" resumeId='");a.push(this.mResumeSessionId);a.push("'")}a.push(" >")}a.push("<WidgetAPI version='1.24");a.push("' account='");a.push(this.mAccount);a.push("' enableStats='");a.push(this.mEnableStats);a.push("' doctype='");a.push(this.mDoctype);if(this.mConfigId){a.push("' configId='");a.push(this.mConfigId)}if(this.mPageId){a.push("' pageId='");a.push(this.mPageId)}if(this.mRequestedKb){a.push("' requestedKb='");a.push(this.mRequestedKb)}a.push("'><pageUrl><![CDATA[");a.push(this.mPageUrl);a.push("]]></pageUrl></WidgetAPI>");a.push("</Login></nR>");return a.join("")};ISQ.Protocol.WidgetClient.prototype.onDataRequestFail=function(a){if(a.request.data.contains("<getUploadParams>")){if(a.token&&a.token.callback){a.token.callback.handle(a)}return}if(++this.mFailedDataRequests===this.mMaxFailedDataRequests){this.connectionStateChanged(ISQ.Protocol.connectionStateEnum.LOGIN_FAILD,a.status);return}this.connectionStateChanged(ISQ.Protocol.connectionStateEnum.RECONNECTING,a.status);this.stripToDataAndSend({data:a.request.data,timeout:a.request.timeout,token:a.token});
this.login()};ISQ.Protocol.WidgetClient.prototype.onResponseReceived=function(a){this.logoutTimerRestart()};ISQ.Protocol.WidgetClient.prototype.logout=function(){this.logoutTimerElapsed()};ISQ.Protocol.WidgetClient.prototype.logoutTimerElapsed=function(){if(this.mServerLog){this.mServerLog.shutdown()}this.connectionStateChanged(ISQ.Protocol.connectionStateEnum.DISCONNECTED)};ISQ.Protocol.WidgetClient.prototype.logoutTimerStart=function(){var a=this;this.mLogoutTimer=setTimeout(function(){a.logoutTimerElapsed()},this.mLogoutTimeout)};ISQ.Protocol.WidgetClient.prototype.logoutTimerStop=function(){clearTimeout(this.mLogoutTimer)};ISQ.Protocol.WidgetClient.prototype.logoutTimerRestart=function(){this.logoutTimerStop();this.logoutTimerStart()};ISQ.Protocol.WidgetClient.prototype.onIncomingData=function(a){this.mFailedDataRequests=0;if(a.token===null||a.token.callback===null){return}a.token.callback.handle(a)};ISQ.Protocol.WidgetClient.prototype.sendContextAndFormValues=function(a){if(this.mContextsSentToServer){return}var d=!a;if(d){a=[]}var b=this.buildContextsAndFormValuesToSend("setContext",this.mContexts,a);var c=this.buildContextsAndFormValuesToSend("setFormValues",ISQ.Widget.ContactForm.getPreDefinedValues(),a);if(!b&&!c){return}if(d){_session().sendData({data:a.join(""),priority:true})}this.mContextsSentToServer=true};ISQ.Protocol.WidgetClient.prototype.buildContextsAndFormValuesToSend=function(e,c,a){var b=0;for(var d in c){if(!c[d]){continue}++b}if(b===0){return false}a.push("<");a.push(e);a.push(" count='");a.push(b);a.push("'>");for(var d in c){if(!c[d]){continue}a.push("<![CDATA[");a.push(d);a.push("]]><![CDATA[");a.push(c[d]);a.push("]]>")}a.push("</");a.push(e);a.push(">");return true};ISQ.Protocol.WidgetClient.prototype.setContext=function(a){for(var b in a){var c=b.toLowerCase();a[c]=a[b];if(c!==b){delete a[b]}}this.mContexts=a;this.mContextsSentToServer=false;if(this.mState===ISQ.Protocol.connectionStateEnum.CONNECTED){this.sendContextAndFormValues()}};ISQ.Protocol.WidgetClient.prototype.sendQuestion=function(a,g,h,e,f,i,c,d){++this.mQueries;
var b=[];this.sendContextAndFormValues(b);b.push("<question autoQuestion='");b.push(e===true);if(f===true){b.push("' isSameQuery='true")}if(d){b.push("' isAutoComplete='true")}b.push("' requestId='");b.push(h);b.push("'><text><![CDATA[");b.push(ISQ.Data.unHTML(g));b.push("]]></text>");if(typeof(i)!=="undefined"&&c){b.push("<translation language='");b.push(c);b.push("' ><![CDATA[");b.push(i||"");b.push("]]></translation>")}b.push("</question>");_session().sendData(b.join(""),new Ajax.Token({callback:a}))};ISQ.Protocol.WidgetClient.prototype.getAnswerById=function(c,a,e,b,f){++this.mQueries;var d=new Array();d.push("<getAnswerById id='");d.push(a);d.push("' requestId='");d.push(e);if(b){d.push("' autoQuestion='true")}if(f){d.push("' src='");d.push(f)}d.push("' />");_session().sendData(d.join(""),new Ajax.Token({callback:c}))};ISQ.Protocol.WidgetClient.prototype.popularSuggestions=function(d,e,a,c){var b=[];this.sendContextAndFormValues(b);b.push("<suggestions requestId='");b.push(e);if(c.includeAnswers){b.push("' includeAnswers='true")}b.push("'><text><![CDATA[");b.push(ISQ.Data.unHTML(d));b.push("]]></text>");b.push("</suggestions>");_session().sendData(b.join(""),new Ajax.Token({callback:a,tag:c}))};ISQ.Protocol.WidgetClient.prototype.sendContactForm=function(c,g,d,l,f,b,h){var j=new Array();j.push("<contactForm jsonFormat='true");if(f){j.push("' language='");j.push(f)}j.push("'>");l=ISQ.Data.unHTML(l);originalSubject="";j.push("<fields><![CDATA[ [");if(d.values&&typeof(d.values)!="function"){d=d.values}for(var k=0;k<d.length;++k){var a=ISQ.Data.unHTML(d[k].value);switch(d[k].type.toLowerCase()){case"message":case"textarea":case"comments":case"originaltextarea":a=a.replacer([{from:"\r\n",to:"<br/>"},{from:"\n",to:"<br/>"}]);break}if(b){a=ISQ.Data.blockCreditCardNumbers(a,b);l=ISQ.Data.blockCreditCardNumbers(l,b)}j.push('{ "name": "');j.push(ISQ.Tools.Base64.encodeString(d[k].name));j.push('", "type": "');j.push(d[k].type);j.push('", "value": "');j.push(ISQ.Tools.Base64.encodeString(a));j.push('" }');if(k!=d.length-1){j.push(",")
}if(d[k].type==="subject"){l=a}if(d[k].type==="originalSubject"){originalSubject=a}if(typeof(d[k].value)==="undefined"||typeof(d[k].name)==="undefined"||typeof(d[k].type)==="undefined"){this.sendServerLog(ISQ.Protocol.ServerLog.eLevelEnum.ERROR,"Undefined value in contactForm. name:"+d[k].name+", type:"+d[k].type+", value:"+d[k].value)}}j.push("] ]]></fields>");j.push("</contactForm>");var e=new Array();this.sendContextAndFormValues(e);e.push("<event type='postQuestion'");e.push(" escType='");e.push(h);e.push("' >");if(f){e.push("<translation language='");e.push(f);e.push("'><![CDATA[");e.push(l);e.push("]]></translation>")}if(isNaN(g)){g=-1}e.push("<question searchResultId='");e.push(g);e.push("'><![CDATA[");e.push(originalSubject||l);e.push("]]></question>");e.push(j.join(""));e.push("</event>");_session().sendData({data:e.join(""),token:new Ajax.Token({callback:c,tag:{escType:h,query:l}}),timeout:60000})};ISQ.Protocol.WidgetClient.prototype.escalateQuestion=function(b,a,h,f,i,g,c,d){var e=new Array();this.sendContextAndFormValues(e);e.push("<event type='postQuestion'");e.push(" escType='");e.push(g);if(d){e.push("' configId='");e.push(d)}else{e.push("' configId='");e.push("nothing")}if(c){e.push("' chatStartAction='");e.push(c)}e.push("' >");if(f){e.push("<translation language='");e.push(f);e.push("'><![CDATA[");e.push(i);e.push("]]></translation>")}if(isNaN(a)){a=-1}e.push("<question searchResultId='");e.push(a);e.push("'><![CDATA[");e.push(ISQ.Data.unHTML(h));e.push("]]></question>");e.push("</event>");_session().sendData(e.join(""),new Ajax.Token({callback:b,tag:{escType:g,query:h}}))};ISQ.Protocol.WidgetClient.prototype.thumbClicked=function(b,a,e,f,d,g){var c=new Array();c.push("<event type='thumb-event' topicId='");c.push(a);c.push("' keywordsetId='");c.push(e);c.push("' thumbDirection='");c.push(g);c.push("'><question kbLC='");c.push(d||"");c.push("' ><![CDATA[");c.push(ISQ.Data.unHTML(f));c.push("]]></question>");c.push("</event>");_session().sendData(c.join(""),new Ajax.Token({callback:b}))};ISQ.Protocol.WidgetClient.prototype.translationFailed=function(d,e,a,b){var c=new Array();
c.push("<event type='translationFailed' errorCode='");c.push(d);if(a!=null){c.push("' apiProvider='");c.push(a)}c.push("'>");if(e){c.push("<message><![CDATA[");c.push(e);c.push("]]></message>")}c.push("</event>");_session().sendData(c.join(""),new Ajax.Token({callback:b}))};ISQ.Protocol.WidgetClient.prototype.requestPrechatSurvey=function(a,b,e,c){var d=new Array();d.push("<preChatSurvey ");d.push("encoding='");if(e){d.push(e)}d.push("'");d.push("><urlBase><![CDATA[https://api.liveperson.net/api/account/");d.push(a);d.push("]]></urlBase>");d.push("<urlParams><![CDATA[");d.push("?v=1&appKey=");d.push(b);d.push("]]></urlParams></preChatSurvey>");_session().sendData(d.join(""),new Ajax.Token({callback:c}))};ISQ.Protocol.WidgetClient.prototype.chatRequest=function(f,a,b,e,c){var d=new Array();d.push("<requestChatStart><url><![CDATA[");d.push(f);d.push(".json?v=1&appKey=");d.push(b);d.push("]]></url>");d.push("<jsonData><![CDATA[");d.push(e);d.push("]]></jsonData>");d.push("</requestChatStart>");_session().sendData(d.join(""),new Ajax.Token({callback:c}))};ISQ.Protocol.WidgetClient.prototype.requestChatSuggestions=function(a,c,d){var b=new Array();b.push("<chatSuggestion");b.push(" requestId='");b.push(d);b.push("'><![CDATA[");b.push(ISQ.Data.unHTML(c));b.push("]]>");b.push("</chatSuggestion>");_session().sendData(b.join(""),new Ajax.Token({callback:a}))};ISQ.Protocol.WidgetClient.prototype.sendChatLine=function(c,b){return;var a=new Array();a.push("<chatlinereport");a.push(" type='");a.push(c);a.push("'><![CDATA[");a.push(b);a.push("]]>");a.push("</chatlinereport>");_session().sendData(a.join(""))};ISQ.Protocol.WidgetClient.prototype.chatEnded=function(){return;_session().sendData("<chatclosedreport />")};ISQ.Protocol.WidgetClient.prototype.trackUser=function(a){var b=[];b.push("<trackeUser><![CDATA[");ISQ.Widget.EndUserTracking.appendToRequest(b);b.push("]]></trackeUser>");_session().sendData(b.join(""),new Ajax.Token({callback:a}))};