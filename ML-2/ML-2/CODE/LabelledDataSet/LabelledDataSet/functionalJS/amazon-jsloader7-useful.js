

 P.execute(function() {
     var begin_time = Date.now();

     var btf_hero_content = [{"callbackUrl":"/gp/gw/ajax/desktop/herotator/record-impressions.html?ie=UTF8&aPTID=36701&cmpnId=427061362&cnttId=1&h=DE5B10970BEBEA0EE7451DDECB549E670731F6CD5&mId=ATVPDKIKX0DER&mkId=ATVPDKIKX0DER&pId=1979642862&pIdent=desktop&rId=1BB039VX1XJ9CTCMZHE64&sid=8&slotName=desktop-hero-2","content":"\n    \n    \n    \n    \n    \n    \n\n    \n     \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n\n \n\n    \n  \n    \n\n\n\n\n    \n\n \n\n\n\n\n\n\n    \n    \n\n    \n    \n     \n\n\n\n\n\n\n\n\n    \n\n    \n\n\n\n\n\n\n\n\n\n\n  \n \n\n\n\n\n\n\n<style>\n    #image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_ .cropped-image-map-size {\n\tposition:relative;\n\toverflow:hidden;\n\twidth:100%;\n\theight:300px;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_ .cropped-image-map-center-alignment {\n\ttext-align:center;\n\tposition:absolute;\n\t\ttop:0;\n\tright:-200%;\n\tbottom:0;\n\tleft:-200%;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_ .cropped-image-map-left-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:-400%;\n\tbottom:0;\n\tleft:0px;\n\ttext-align:left;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_ .cropped-image-map-right-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:0px;\n\tbottom:0;\n\tleft:-400%;\n\ttext-align:right;\n}\n.cropped-image-map-size img {\n\t max-width: none;\n}\n</style>\n<div id=\"image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_\" class=\"shogun-widget image-map gateway-desktop-map\">\n    <div class=\"cropped-image-map-size\">\n        <div class=\"cropped-image-map-center-alignment\">\n            <map name=\"map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_\">\n  \n\n<area coords=\"0,300,1500,0\" shape=\"rect\" alt=\"Black Friday Deals Week\" href=\"/b/ref=br_imp_ara-1?_encoding=UTF8&node=384082011&pf_rd_m=ATVPDKIKX0DER&pf_rd_s=desktop-hero-2&pf_rd_r=1BB039VX1XJ9CTCMZHE6&pf_rd_t=36701&pf_rd_p=1979642862&pf_rd_i=desktop\">\n\n</map>\n            <span style=\"display:inline-block\">\n              <img alt=\"Black Friday Deals Week\" src=\"http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/SUPERdwa._UX1500_SX1500_V320725784_.png\" class=\"a-dynamic-image\" title=\"Black Friday Deals Week\" height=\"300px\" width=\"1500px\" data-a-dynamic-image=\"{&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/SUPERdwa._UX2250_SX2250_V320725784_.png&quot;:[450,2250],&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/SUPERdwa._UX3000_SX3000_V320725784_.png&quot;:[600,3000],&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/SUPERdwa._UX1500_SX1500_V320725784_.png&quot;:[300,1500],&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/SUPERdwa._V320725784_.png&quot;:[900,4500]}\" usemap=\"#map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3183_\">\n            </span>\n        </div>\n    </div>\n</div>\n","fgID":"desktop-hero-2"},{"callbackUrl":"/gp/gw/ajax/desktop/herotator/record-impressions.html?ie=UTF8&aPTID=36701&cmpnId=427073882&cnttId=1&h=303CE656E682CDE273AD5BA6C94C78F4C151C56E8&mId=ATVPDKIKX0DER&mkId=ATVPDKIKX0DER&pId=1980586602&pIdent=desktop&rId=1BB039VX1XJ9CTCMZHE69&sid=8&slotName=desktop-hero-3","content":"\n    \n    \n    \n    \n    \n    \n\n    \n     \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n\n \n\n    \n  \n    \n\n\n\n\n    \n\n \n\n\n\n\n\n\n    \n    \n\n    \n    \n     \n\n\n\n\n\n\n\n\n    \n\n    \n\n\n\n\n\n\n\n\n\n\n  \n \n\n\n\n\n\n\n<style>\n    #image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_ .cropped-image-map-size {\n\tposition:relative;\n\toverflow:hidden;\n\twidth:100%;\n\theight:300px;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_ .cropped-image-map-center-alignment {\n\ttext-align:center;\n\tposition:absolute;\n\t\ttop:0;\n\tright:-200%;\n\tbottom:0;\n\tleft:-200%;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_ .cropped-image-map-left-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:-400%;\n\tbottom:0;\n\tleft:0px;\n\ttext-align:left;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_ .cropped-image-map-right-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:0px;\n\tbottom:0;\n\tleft:-400%;\n\ttext-align:right;\n}\n.cropped-image-map-size img {\n\t max-width: none;\n}\n</style>\n<div id=\"image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_\" class=\"shogun-widget image-map gateway-desktop-map\">\n    <div class=\"cropped-image-map-size\">\n        <div class=\"cropped-image-map-center-alignment\">\n            <map name=\"map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_\">\n  \n\n<area coords=\"0,900,4500,0\" shape=\"rect\" alt=\"Women&#39;s Top Gifts\" href=\"/b/ref=br_imp_ara-1?_encoding=UTF8&node=7147440011&pf_rd_m=ATVPDKIKX0DER&pf_rd_s=desktop-hero-3&pf_rd_r=1BB039VX1XJ9CTCMZHE6&pf_rd_t=36701&pf_rd_p=1980586602&pf_rd_i=desktop\">\n\n</map>\n            <span style=\"display:inline-block\">\n              <img alt=\"Women&#39;s Top Gifts\" src=\"http://g-ecx.images-amazon.com/images/G/01/AMAZON_FASHION/2014/WAYFINDING/EDITORIAL/HOL_2/GATEWAY/HERO/HERO_WOMEN_THG_COAT._UX1500_SX1500_V320700442_.jpg\" class=\"a-dynamic-image\" title=\"Women&#39;s Top Gifts\" height=\"300px\" width=\"1500px\" data-a-dynamic-image=\"{&quot;http://g-ecx.images-amazon.com/images/G/01/AMAZON_FASHION/2014/WAYFINDING/EDITORIAL/HOL_2/GATEWAY/HERO/HERO_WOMEN_THG_COAT._UX3000_SX3000_V320700442_.jpg&quot;:[600,3000],&quot;http://g-ecx.images-amazon.com/images/G/01/AMAZON_FASHION/2014/WAYFINDING/EDITORIAL/HOL_2/GATEWAY/HERO/HERO_WOMEN_THG_COAT._UX2250_SX2250_V320700442_.jpg&quot;:[450,2250],&quot;http://g-ecx.images-amazon.com/images/G/01/AMAZON_FASHION/2014/WAYFINDING/EDITORIAL/HOL_2/GATEWAY/HERO/HERO_WOMEN_THG_COAT._V320700442_.jpg&quot;:[900,4500],&quot;http://g-ecx.images-amazon.com/images/G/01/AMAZON_FASHION/2014/WAYFINDING/EDITORIAL/HOL_2/GATEWAY/HERO/HERO_WOMEN_THG_COAT._UX1500_SX1500_V320700442_.jpg&quot;:[300,1500]}\" usemap=\"#map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3184_\">\n            </span>\n        </div>\n    </div>\n</div>\n","fgID":"desktop-hero-3"},{"callbackUrl":"/gp/gw/ajax/desktop/herotator/record-impressions.html?ie=UTF8&aPTID=36701&cmpnId=426371622&cnttId=1&h=449D3E72E6C4B7B25A2CF2D8A741F0F9A9E00EDB6&mId=ATVPDKIKX0DER&mkId=ATVPDKIKX0DER&pId=1978160162&pIdent=desktop&rId=1BB039VX1XJ9CTCMZHE62&sid=8&slotName=desktop-hero-4","content":"\n    \n    \n    \n    \n    \n    \n\n    \n     \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n\n \n\n    \n  \n    \n\n\n\n\n    \n\n \n\n\n\n\n\n\n    \n    \n\n    \n    \n     \n\n\n\n\n\n\n\n\n    \n\n    \n\n\n\n\n\n\n\n\n\n\n  \n \n\n\n\n\n\n\n<style>\n    #image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_ .cropped-image-map-size {\n\tposition:relative;\n\toverflow:hidden;\n\twidth:100%;\n\theight:300px;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_ .cropped-image-map-center-alignment {\n\ttext-align:center;\n\tposition:absolute;\n\t\ttop:0;\n\tright:-200%;\n\tbottom:0;\n\tleft:-200%;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_ .cropped-image-map-left-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:-400%;\n\tbottom:0;\n\tleft:0px;\n\ttext-align:left;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_ .cropped-image-map-right-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:0px;\n\tbottom:0;\n\tleft:-400%;\n\ttext-align:right;\n}\n.cropped-image-map-size img {\n\t max-width: none;\n}\n</style>\n<div id=\"image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_\" class=\"shogun-widget image-map gateway-desktop-map\">\n    <div class=\"cropped-image-map-size\">\n        <div class=\"cropped-image-map-center-alignment\">\n            <map name=\"map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_\">\n  \n\n<area coords=\"0,900,4500,0\" shape=\"rect\" alt=\"Unlimited Streaming on Prime Instant Video\" href=\"/gp/video/primesignup/ref=dvm_us_cw_cs_gensuperhoft?pf_rd_m=ATVPDKIKX0DER&pf_rd_s=desktop-hero-4&pf_rd_r=1BB039VX1XJ9CTCMZHE6&pf_rd_t=36701&pf_rd_p=1978160162&pf_rd_i=desktop\">\n\n</map>\n            <span style=\"display:inline-block\">\n              <img alt=\"Unlimited Streaming on Prime Instant Video\" src=\"http://g-ecx.images-amazon.com/images/G/01/digital/video/merch/gateway/superhero/GW_PIV_Superhero_Evergreen_V1_4500x900._UX1500_SX1500_V322757148_.jpg\" class=\"a-dynamic-image\" title=\"Unlimited Streaming on Prime Instant Video\" height=\"300px\" width=\"1500px\" data-a-dynamic-image=\"{&quot;http://g-ecx.images-amazon.com/images/G/01/digital/video/merch/gateway/superhero/GW_PIV_Superhero_Evergreen_V1_4500x900._V322757148_.jpg&quot;:[900,4500],&quot;http://g-ecx.images-amazon.com/images/G/01/digital/video/merch/gateway/superhero/GW_PIV_Superhero_Evergreen_V1_4500x900._UX2250_SX2250_V322757148_.jpg&quot;:[450,2250],&quot;http://g-ecx.images-amazon.com/images/G/01/digital/video/merch/gateway/superhero/GW_PIV_Superhero_Evergreen_V1_4500x900._UX1500_SX1500_V322757148_.jpg&quot;:[300,1500],&quot;http://g-ecx.images-amazon.com/images/G/01/digital/video/merch/gateway/superhero/GW_PIV_Superhero_Evergreen_V1_4500x900._UX3000_SX3000_V322757148_.jpg&quot;:[600,3000]}\" usemap=\"#map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3185_\">\n            </span>\n        </div>\n    </div>\n</div>\n","fgID":"desktop-hero-4"},{"callbackUrl":"/gp/gw/ajax/desktop/herotator/record-impressions.html?ie=UTF8&aPTID=36701&cmpnId=425551322&cnttId=1&h=55F9ED3304B4D2FB26E675858E0EC0253EA09B437&mId=ATVPDKIKX0DER&mkId=ATVPDKIKX0DER&pId=1978160842&pIdent=desktop&rId=1BB039VX1XJ9CTCMZHE64&sid=8&slotName=desktop-hero-5","content":"\n    \n    \n    \n    \n    \n    \n\n    \n     \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n\n \n\n    \n  \n    \n\n\n\n\n    \n\n \n\n\n\n\n\n\n    \n    \n\n    \n    \n     \n\n\n\n\n\n\n\n\n    \n\n    \n\n\n\n\n\n\n\n\n\n\n  \n \n\n\n\n\n\n\n<style>\n    #image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_ .cropped-image-map-size {\n\tposition:relative;\n\toverflow:hidden;\n\twidth:100%;\n\theight:300px;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_ .cropped-image-map-center-alignment {\n\ttext-align:center;\n\tposition:absolute;\n\t\ttop:0;\n\tright:-200%;\n\tbottom:0;\n\tleft:-200%;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_ .cropped-image-map-left-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:-400%;\n\tbottom:0;\n\tleft:0px;\n\ttext-align:left;\n}\n#image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_ .cropped-image-map-right-alignment {\n\tposition:absolute;\n\t\ttop:0;\n\tright:0px;\n\tbottom:0;\n\tleft:-400%;\n\ttext-align:right;\n}\n.cropped-image-map-size img {\n\t max-width: none;\n}\n</style>\n<div id=\"image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_\" class=\"shogun-widget image-map gateway-desktop-map\">\n    <div class=\"cropped-image-map-size\">\n        <div class=\"cropped-image-map-center-alignment\">\n            <map name=\"map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_\">\n  \n\n<area coords=\"0,900,4500,0\" shape=\"rect\" alt=\"Kindle w Touch\" href=\"/dp/B00I15SB16/ref=br_imp_ara-1?pf_rd_m=ATVPDKIKX0DER&pf_rd_s=desktop-hero-5&pf_rd_r=1BB039VX1XJ9CTCMZHE6&pf_rd_t=36701&pf_rd_p=1978160842&pf_rd_i=desktop\">\n\n</map>\n            <span style=\"display:inline-block\">\n              <img alt=\"Kindle w Touch\" src=\"http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/kindleparkII._UX1500_SX1500_V323432045_.jpg\" class=\"a-dynamic-image\" title=\"Kindle w Touch\" height=\"300px\" width=\"1500px\" data-a-dynamic-image=\"{&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/kindleparkII._UX3000_SX3000_V323432045_.jpg&quot;:[600,3000],&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/kindleparkII._V323432045_.jpg&quot;:[900,4500],&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/kindleparkII._UX2250_SX2250_V323432045_.jpg&quot;:[450,2250],&quot;http://g-ecx.images-amazon.com/images/G/01/Gateway/Heroes/kindleparkII._UX1500_SX1500_V323432045_.jpg&quot;:[300,1500]}\" usemap=\"#map_0_image-map-ns_1BB039VX1XJ9CTCMZHE6_3186_\">\n            </span>\n        </div>\n    </div>\n</div>\n","fgID":"desktop-hero-5"}];
     var hero_unloaded_images = {};

     var autorotations_maximum = btf_hero_content.length + 1;
     var autorotations_count = 0;
     var autorotation_delay = 5000; // default to 5 seconds
     var stopped = false;

     var a_carousel = undefined;
     var autorotation_state = UnreadyState();

     var tick_delay = 1000; //ms
     var delay_countdown = 0;

     P.register("gw-desktop-herotator", function() {
         return {
             get_autorotation_delay: function() {
                 return autorotation_delay;
             },
             set_autorotation_delay: function(arg) {
                 autorotation_delay = parseInt(arg);
             }
         };
     });

     var desktopHerotatorEl = document.getElementById("gw-desktop-herotator");
     add_event_listener(desktopHerotatorEl, 'click',       on_user_interaction);
     add_event_listener(desktopHerotatorEl, 'touchstart',  on_user_interaction);
     add_event_listener(desktopHerotatorEl, 'touchmove',   on_user_interaction);
     add_event_listener(desktopHerotatorEl, 'touchend',    on_user_interaction);
     add_event_listener(desktopHerotatorEl, 'touchcancel', on_user_interaction);
     add_event_listener(desktopHerotatorEl, 'mouseenter',  on_mouse_move);
     add_event_listener(desktopHerotatorEl, 'mousemove',   on_mouse_move);

     var spinner_death_classname_regex = new RegExp("\\s*\\ba\\-lazy\\-loaded\\b\\s*");

     var gw_ftGr_desktop_hero_1 = document.getElementById("gw-ftGr-desktop-hero-1");
     var desktop_hero_1_imgs = gw_ftGr_desktop_hero_1.getElementsByTagName("img");
     load_images("desktop-hero-1", desktop_hero_1_imgs || []);

     P.when("A", "gw-desktop-herotator", "a-carousel-framework",  "cf").execute(function(A, gw_desktop_herotator, a_carousel_framework) {
         a_carousel_framework.onInit("gateway-desktop-layout.herotator", function on_carousel_initialized(){
             A.on("a:carousel:gateway-desktop-layout.herotator:change:pageNumber", function(data) {
                 var pageNum = data.newValue;
                 record_impression(pageNum);
             });
             var $a_carousel_container = A.$("#gw-desktop-herotator > .a-carousel-container");
             a_carousel = a_carousel_framework.getCarousel($a_carousel_container);
             populate_btf_hero_slots();
             autorotation_state.carousel_init();
         });

     });

     return;

     function populate_btf_hero_slots() {
         var fgIndex = 0;
         while(btf_hero_content[fgIndex]) {
             populate_slot_content(btf_hero_content[fgIndex].fgID, btf_hero_content[fgIndex].content);
             fgIndex++;
         }
     }

     function record_impression(page_number) {
         P.when("A").execute(function(A) {
             var btf_hero_content_index = (page_number - 2);
             if(btf_hero_content[btf_hero_content_index] && btf_hero_content[btf_hero_content_index].callbackUrl) {
                 A.$.post(btf_hero_content[btf_hero_content_index].callbackUrl);
                 delete btf_hero_content[btf_hero_content_index].callbackUrl;
             }
         });
     }

     function on_user_interaction() {
         if(!stopped) {
             log_user_interaction_before_autorotation_completion();
         }
         stop_autorotate();
     }

     function on_mouse_move() {
         clearTimeout(on_mouse_move.timeout_id);
         on_mouse_move.timeout_id = setTimeout(function() {
             delay_countdown = Math.max(delay_countdown, 3);
         }, 0);
     }

     function stop_autorotate() {
         stopped = true;
     }

     function populate_slot_content(fgID, content) {
         var ftGrEl = document.getElementById("gw-ftGr-"+fgID);
         var classAttr = ftGrEl.getAttribute("class");
         if(!spinner_death_classname_regex.test(classAttr)) {
             return
         }
         ftGrEl.setAttribute("class", classAttr.replace(spinner_death_classname_regex, ""));
         ftGrEl.innerHTML = content;
         var imgEls = ftGrEl.getElementsByTagName("img");
         load_images(fgID, imgEls);
     }

     function load_images(fgID, imgEls) {
         hero_unloaded_images[fgID] = [];
         var img_count = imgEls.length;
         if(img_count > 0) {
             for(var i=0; i<img_count; i++) {
                 (function(i) {
                     var image = new Image();
                     image.onload = function() {
                         hero_unloaded_images[fgID].splice(index_of(hero_unloaded_images[fgID], image), 1);
                         if(check_if_all_images_loaded(fgID)) {
                             autorotation_state.hero_images_loaded(fgID);
                         }
                     }
                     hero_unloaded_images[fgID].push(image);
                     image.src = imgEls[i].src;
                 }(i));
             }
         }
         else {
             autorotation_state.hero_images_loaded(fgID);
         }
         check_if_all_images_loaded(fgID);
     }

     function check_if_all_images_loaded(fgID) {
         var loaded = !!(hero_unloaded_images[fgID] && hero_unloaded_images[fgID].length === 0);
         return loaded;
     }

     function log_spinner_death() {
         if(log_spinner_death.sent) { return; }
         increment_ctr({"exp":"1416882127","rID":"1BB039VX1XJ9CTCMZHE6","h":"B23CF0599B553A661A08BF7BCED5A29A26DA316A","ctr":"desktop_herotator_spinner_death"});
         log_spinner_death.sent = true;
     }

     function log_premature_autorotation() {
         if(log_premature_autorotation.sent) { return; }
         increment_ctr({"exp":"1416882127","rID":"1BB039VX1XJ9CTCMZHE6","h":"623FB3808254B00A9CD5C341BD78FCAD36A5DB6B","ctr":"desktop_herotator_premature_autorotation"});
         log_premature_autorotation.sent = true;
     }

     function log_user_interaction_before_autorotation_completion() {
         if(log_user_interaction_before_autorotation_completion.sent) { return; }
         clearTimeout(log_user_interaction_before_autorotation_completion.timeout);
         log_user_interaction_before_autorotation_completion.timeout = setTimeout(function() {
             increment_ctr({"exp":"1416882127","rID":"1BB039VX1XJ9CTCMZHE6","h":"1617AD7A3D52DBAE0B5D4798BCF1808F93E4CD4F","ctr":"desktop_herotator_user_interaction_before_autorotation_completion"});
             log_user_interaction_before_autorotation_completion.sent = true;
         }, 2000);
     }

     function increment_ctr(data) {
         var ajaxMethod = "post";
         var ajaxHandler = "/gp/gw/ajax/ctr.html";
         P.when('A').execute(function(A) {
             A.$.ajax(ajaxHandler, {async:false, cache:false, type:ajaxMethod, data:data});
         });
     }
 
     function tick() {
         delay_countdown--;
         if(delay_countdown <= 0) {
             autorotation_state.delay_complete();
         }
         if(!stopped) {
             setTimeout(tick, tick_delay);
         }
     }

     function begin_delay_countdown() {
         var since_begin_time = (Date.now() - begin_time);
         delay_countdown = Math.max(1, (autorotation_delay-since_begin_time)/tick_delay);
         setTimeout(tick, tick_delay);
     }

     function reset_delay_countdown(arg) {
         delay_countdown = Math.max(arg || (autorotation_delay/tick_delay), delay_countdown);
     }

     function add_event_listener(element, evt, fn) {
         if (element.addEventListener) {
             element.addEventListener(evt, fn, false);
         }
         else {
             element.attachEvent("on"+evt, fn);
         }
     }

     function index_of(arr, el) {
         if(arr.indexOf) { return arr.indexOf(el); }
         for(var i=0; i<arr.length; i++) {
             if(arr[i] === el) { return i; }
         }
     }

     function create_controls() {
         P.when("A").execute(function(A) {
             A.$("#gw-desktop-herotator").addClass("gw-desktop-herotator-ready");
             var $controls_el = A.$("#gw-desktop-herotator-controls");
             var $controls_links = $controls_el.find("a");
             $controls_links.click(function(e) {
                var m = undefined;
                var class_attr = A.$(this).attr("class") || "";
                if(m = class_attr.match(/\bherotator\-goToPage\-(\d+)\b/)) {
                    var page_num = Number(m[1]);
                    a_carousel.gotoPage(page_num);
                    on_user_interaction();
                    e.preventDefault();
                }
             });
             $controls_links.each(function() {
                 var $heroEl = A.$(A.$(this).attr("href"));
                 var altText = $heroEl.find(".gw-ftGr-desktop-hero-alt").text();
                 altText = altText || $heroEl.find(".image-map.shogun-widget img").attr("alt");
                 if(altText) {
                     A.$(this).find(".gw-text").text(altText);
                 }
             });
             $controls_el.find("li").fadeIn(800);
             A.on("a:carousel:gateway-desktop-layout.herotator:change:pageNumber", function(data) {
                 var pageNum = data.newValue;
                 A.$("#gw-desktop-herotator-controls li a").removeClass("active");
                 A.$("#gw-desktop-herotator-controls li a.herotator-goToPage-"+pageNum).addClass("active");
             });
         });
     }

     /* State Constructors */

     function BaseAutorotationState(arg) {
         arg = arg || {};
         var noop = function() {};
         return {
             delay_complete     : arg.delay_complete || noop,
             carousel_init      : arg.carousel_init || noop,
             hero_images_loaded : arg.hero_images_loaded || noop
         };
     }

     function UnreadyState() {
         var carousel_init = false;
         return BaseAutorotationState({
             hero_images_loaded: function(fgID) {
                 if(fgID === 'desktop-hero-1') {
                     begin_delay_countdown();
                     check_if_ready();
                 }
             },
             carousel_init: function() {
                 carousel_init = true;
                 check_if_ready();
             }
         });

         function check_if_ready() {
             if(check_if_all_images_loaded("desktop-hero-1") && carousel_init) {
                 create_controls();
                 autorotation_state = PendingState();
                 return true;
             }
             else {
                 return false;
             }
         }

     }

     function PendingState() {
         if(autorotations_count >= btf_hero_content.length) {
             return PendingFinalRotationState();
         }
         var nextfgID = btf_hero_content[(autorotations_count)].fgID;
         return BaseAutorotationState({
             hero_images_loaded: function(fgID) {
                 if(fgID === nextfgID) {
                     autorotation_state = PendingDelayState();
                 }
             },
             delay_complete: function() {
                 autorotation_state = PendingImagesLoadedState();
             }
         });
     }

     function PendingDelayState() {
         return BaseAutorotationState({
             delay_complete: function() {
                 autorotation_state = AutorotatingState();
             }
         });
     }

     function PendingImagesLoadedState() {
             var nextfgID = btf_hero_content[(autorotations_count)].fgID;
             if(check_if_all_images_loaded(nextfgID)) {
                 return AutorotatingState();
             }
             return BaseAutorotationState({
                 hero_images_loaded: function(fgID) {
                     if(fgID === nextfgID) {
                         autorotation_state = AutorotatingState();
                     }
                 }
             });
     }

     function PendingFinalRotationState() {
         return PendingDelayState();
     }

     function AutorotatingState() {
         autorotations_count++;
         var skip = false;
         if(autorotations_count <= autorotations_maximum) {
             if(btf_hero_content[(autorotations_count-1)]) {
                 var fgID = btf_hero_content[(autorotations_count-1)].fgID;
                 var ftGrEl = document.getElementById("gw-ftGr-"+fgID);

                 if(spinner_death_classname_regex.test(ftGrEl.getAttribute("class"))) {
                     log_spinner_death();
                     skip = true;
                 }

                 if(!check_if_all_images_loaded(fgID)) {
                     log_premature_autorotation();
                 }
             }

             if(btf_hero_content[autorotations_count]) {
                 populate_slot_content(btf_hero_content[autorotations_count].fgID, btf_hero_content[autorotations_count].content);
             }
             if(!stopped) {
                 var page = (autorotations_count % autorotations_maximum)+1;
                 a_carousel.gotoPage(page);
             }

             if(skip) {
                 return AutorotatingState();
             }
         }
         else {
             stop_autorotate();
             return BaseAutorotationState({});
         }
         reset_delay_countdown();
         return PendingState();
     }
 });
 