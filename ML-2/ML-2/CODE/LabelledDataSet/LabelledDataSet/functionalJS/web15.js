if(typeof(Ajax)==="undefined"){throw ("Ajax Pool: missing Ajax namespace")}Ajax.Pool=ISQ.Base.extend({name:"Ajax.Pool"});Ajax.Pool.prototype.ctor=function(f,j,b,c,d,a){try{j=j||0;f=f||null;if(f===null){throw ("ajax pool init - no default url");return null}if(j===0){return null}this.mDebug={};this.mDebug.mSentRequests=0;this.mDebug.mCanceledRequests=0;this.mDebug.mReceivedResponses=0;this.queue=new ISQ.Infra.Queue();this.size=this.freeAjax=j;this.Defaults={};this.Defaults.method=b||Ajax.methodEnum.POST;this.Defaults.requestType=c||Ajax.typeEnum.ASYNC;this.Defaults.url=f;this.Defaults.timeout=d||10000;this.Defaults.Headers=a||new Ajax.Headers();this.state=Ajax.Pool.stateEnum.GO;this.ajaxPool=new Array();for(var h=0;h<this.size;++h){this.ajaxPool[h]=new Ajax.Request(this.Defaults.url,this.Defaults.method,this.Defaults.requestType,this.Defaults.Headers);this.ajaxPool[h].incomingResponseEvent.addHandler(this.responseHandler,this);this.ajaxPool[h].timeout=d}this.incomingResponseEvent=new ISQ.Event();Ajax.Pool.RequestInfo.Pool.init(5)}catch(g){throw (g.message)}};Ajax.Pool.prototype.dtor=function(){if(this.isDisposed){return}this.isDisposed=true;this.stop();this.incomingResponseEvent.dispose();this.queue.dispose();this.abortAll();delete this.Defaults;delete this.mDebug};Ajax.Pool.prototype.incomingResponseEvent=null;Ajax.Pool.prototype.queue=null;Ajax.Pool.prototype.size=0;Ajax.Pool.prototype.freeAjax=0;Ajax.Pool.prototype.ajaxPool=null;Ajax.Pool.prototype.hasInitiated=false;Ajax.Pool.prototype.mDebug=null;Ajax.Pool.prototype.isPrepareToDie=false;Ajax.Pool.prototype.Defaults=null;Ajax.Pool.prototype.state=null;Ajax.Pool.prototype.stop=function(){this.state=Ajax.Pool.stateEnum.STOP};Ajax.Pool.prototype.go=function(){if(this.state===Ajax.Pool.stateEnum.STOP){this.state=Ajax.Pool.stateEnum.GO;this.processQ()}};Ajax.Pool.prototype.restart=function(){this.clear();this.go()};Ajax.Pool.prototype.clear=function(){this.queue.reset()};Ajax.Pool.prototype.abortAll=function(){for(var a=0;a<this.size;++a){this.ajaxPool[a].dispose()}};
Ajax.Pool.prototype.setDefaultHeaders=function(a){if(a instanceof Ajax.Headers){if(this.Defaults.Headers!==null){this.Defaults.Headers.dispose()}this.Defaults.Headers=a}};Ajax.Pool.prototype.setDefaultUrl=function(a){this.Defaults.url=a};Ajax.Pool.prototype.processQ=function(){if(this.isDisposed()){return}if(this.state===Ajax.Pool.stateEnum.STOP){return}if(this.queue.count()===0){return}try{var a=null;for(var d=0;d<this.size&&a===null;++d){if(!this.ajaxPool[d].mIsRunning){a=this.ajaxPool[d]}}if(a!==null){a.Headers=null;var f=null;do{if(f){Ajax.Pool.RequestInfo.Pool.returnObject(f);++this.mDebug.mCanceledRequests}f=this.queue.dequeue()}while(f&&f.mCanceled);if(f){a.tag=f;if(f.mUrl!==null){a.mUrl=f.mUrl}else{a.mUrl=this.Defaults.url}if(f.mHeaders!==null){a.Headers=f.mHeaders}else{a.Headers=this.Defaults.Headers}if(f.mTimeout!==null){a.timeout=f.mTimeout}else{a.timeout=this.Defaults.timeout}if(f.mToken!==null){a.token=f.mToken}else{a.token=null}if(f.mMethod!==null){a.mRequestMethod=f.mMethod}else{a.mRequestMethod=this.Defaults.method}var b=f.mData;try{--this.freeAjax;++this.mDebug.mSentRequests;if(this.isPrepareToDie){a.mRequestType=Ajax.typeEnum.SYNC}a.send(b)}catch(c){++this.freeAjax;--this.mDebug.mSentRequests;if(debugLevel){if(typeof(_debug)==="function"){_debug().insertText("Ajax pool processQ: send data exception: "+c)}else{alert("Ajax pool processQ: send data exception: "+c)}}}}}else{}}catch(c){if(debugLevel){alert("Ajax pool process Q exception: "+c)}}};Ajax.Pool.prototype.add=function(){if(this.isDisposed()){return}var a;if(arguments.length===1&&typeof(arguments[0])==="object"){a=arguments[0]}else{a={data:arguments[0],url:arguments[1],token:arguments[2],headers:arguments[3],timeout:arguments[4],priority:arguments[5],method:arguments[6]}}a.priority=a.priority===true;if(a.token!==null&&!a.token instanceof Ajax.Token){throw ("Ajax.Pool.prototype.add: token is not of type Ajax.Token")}var b=Ajax.Pool.RequestInfo.Pool.getObject();b.mData=a.data||"";b.mUrl=a.url||null;b.mToken=a.token||null;b.mHeaders=a.headers||null;
b.mTimeout=a.timeout||null;b.mMethod=a.method||null;if(a.priority){this.queue.priorityEnqueue(b)}else{this.queue.enqueue(b)}if(!this.isPrepareToDie){var c=this;setTimeout(function(){c.processQ()},0)}else{this.processQ()}return b.mIndex};Ajax.Pool.prototype.cancelRequest=function(b){var c=Ajax.Pool.RequestInfo.Pool.getUsedObjectByIndex(b);if(c===null){return false}c.mCanceled=true;if(c.mIsInUse){for(var a=0;a<this.size;++a){if(this.ajaxPool[a].mIsRunning&&this.ajaxPool[a].tag.mIndex===b){this.ajaxPool[a].abort();break}}}return true};Ajax.Pool.prototype.responseHandler=function(c){try{if(this.isDisposed()){return}if(!c.chunk){++this.freeAjax;++this.mDebug.mReceivedResponses;var a=false;if(c.request.tag){a=c.request.tag.mCanceled;Ajax.Pool.RequestInfo.Pool.returnObject(c.request.tag);c.request.tag=null}if(!a){this.incomingResponseEvent.dispatch(c)}if(this.isDisposed()){return}if(!this.isPrepareToDie){var d=this;setTimeout(function(){d.processQ()},0)}else{this.processQ()}}else{this.incomingResponseEvent.dispatch(c)}}catch(b){alert("Ajax.Pool.responseHandler: "+b.message+"\n\nRequest: "+c.request.data+"\n\nUrl:"+c.request.mUrl)}};Ajax.Pool.stateEnum={GO:1,STOP:2};Ajax.Pool.RequestInfo=ISQ.Base.extend({name:"Ajax.Pool.RequestInfo"});Ajax.Pool.RequestInfo.ndx=0;Ajax.Pool.RequestInfo.prototype.ctor=function(){};Ajax.Pool.RequestInfo.prototype.dtor=function(){};Ajax.Pool.RequestInfo.prototype.mData=null;Ajax.Pool.RequestInfo.prototype.mHeaders=null;Ajax.Pool.RequestInfo.prototype.mToken=null;Ajax.Pool.RequestInfo.prototype.mUrl=null;Ajax.Pool.RequestInfo.prototype.mTimeout=null;Ajax.Pool.RequestInfo.prototype.mIsInUse=false;Ajax.Pool.RequestInfo.prototype.mIndex=-1;Ajax.Pool.RequestInfo.prototype.mCanceled=false;Ajax.Pool.RequestInfo.prototype.mMethod=Ajax.methodEnum.POST;Ajax.Pool.RequestInfo.Pool={};Ajax.Pool.RequestInfo.Pool.arr=null;Ajax.Pool.RequestInfo.Pool.init=function(b){Ajax.Pool.RequestInfo.Pool.arr=[];for(var a=0;a<b;++a){Ajax.Pool.RequestInfo.Pool.arr.push(new Ajax.Pool.RequestInfo())}};Ajax.Pool.RequestInfo.Pool.getUsedObjectByIndex=function(a){var b;
for(i=0;i<Ajax.Pool.RequestInfo.Pool.arr.length;++i){b=Ajax.Pool.RequestInfo.Pool.arr[i];if(b.mIndex===a){return b}}return null};Ajax.Pool.RequestInfo.Pool.getObject=function(){var c=null;var a;for(a=0;a<Ajax.Pool.RequestInfo.Pool.arr.length;++a){c=Ajax.Pool.RequestInfo.Pool.arr[a];if(c.mIsInUse===true){continue}c.mIsInUse=true;c.mIndex=Ajax.Pool.RequestInfo.ndx++;c.mCanceled=false;return c}c=new Ajax.Pool.RequestInfo();c.mIsInUse=true;var b=[];for(a=0;a<Ajax.Pool.RequestInfo.Pool.arr.length;++a){b.push(Ajax.Pool.RequestInfo.Pool.arr[a])}b.push(c);c.mIndex=Ajax.Pool.RequestInfo.ndx++;return c};Ajax.Pool.RequestInfo.Pool.returnObject=function(a){a.mData=null;a.mHeaders=null;a.mToken=null;a.mUrl=null;a.mTimeout=null;a.mIsInUse=false;a.mCanceled=false;a.mMethod=Ajax.methodEnum.POST};