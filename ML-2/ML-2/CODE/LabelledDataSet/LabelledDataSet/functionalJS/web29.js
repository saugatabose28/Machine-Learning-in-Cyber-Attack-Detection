ISQ.Widget=initializeNS("ISQ.Widget");ISQ.Widget.iChat=ISQ.Base.extend({name:"ISQ.Widget.iChat",abstractClass:true});ISQ.Widget.iChat.END_SENTENCE_MARKS=[".","!","?","\n"," "];ISQ.Widget.iChat.LINE_MAX_LENGTH=600;ISQ.Widget.iChat.instance=null;ISQ.Widget.iChat.chatCookieName="chatForResume";ISQ.Widget.iChat.enumState={preinit:0,initiated:1,available:2,requestingChat:4,preChat:8,resumeChat:16,chat:32,userActive:1024};ISQ.Widget.iChat.enumMessageType={visitor_text:0,agent_text:1,system:2,visitor_id:3,agent_id:4,requestChat:5,chatStarted_agent:6,chatStarted_visitor:7,chatEnded:8};ISQ.Widget.iChat.enumRequestChatStatus={inChat:0,requestingChat:1,newChat:2,resumingChat:3,preChat:4,popup:5};ISQ.Widget.iChat.abstractClass.onRequestChat;ISQ.Widget.iChat.abstractClass.onEndChat;ISQ.Widget.iChat.abstractClass.onChatStopped;ISQ.Widget.iChat.abstractClass.onChatError;ISQ.Widget.iChat.abstractClass.onChatStarted;ISQ.Widget.iChat.abstractClass.onSendMessage;ISQ.Widget.iChat.abstractClass.onSendAnswerId;ISQ.Widget.iChat.abstractClass.onUserTyping;ISQ.Widget.iChat.abstractClass.supportingEmailChat;ISQ.Widget.iChat.abstractClass.emailChat;ISQ.Widget.iChat.abstractClass.agentName;ISQ.Widget.iChat.abstractClass.getDataToSave;ISQ.Widget.iChat.abstractClass.showPostChat;ISQ.Widget.iChat.prototype.ctor=function(a){if(ISQ.Widget.iChat.instance){ISQ.Widget.iChat.instance.dispose()}ISQ.Widget.iChat.instance=this;this.mConfig=a.config;this.hAgentTyping=a.hAgentTyping;this.hIncomingMessage=a.hIncomingMessage;this.hChatEnded=a.hChatEnded;this.hChatStarted=a.hChatStarted;this.hResumingChat=a.hResumingChat;this.hChatRequested=a.hChatRequested;this.hChatAvailableChanged=a.hChatAvailableChanged;this.hConnectionError=a.hConnectionError;this.hShowActionBar=a.hShowActionBar};ISQ.Widget.iChat.prototype.dtor=function(){};ISQ.Widget.iChat.prototype.sendMessage_internal=function(k,o){if(!this.inChat()){if(!this.requestingChat()){return}if(!this.mPendingMessages){this.mPendingMessages=[]}this.mPendingMessages.push(k)}else{this.userTyping(false);var j=k.text;
var c=ISQ.Data.getURLencodedString(ISQ.Data.unHTML(j));if(!this.mMessagesQueue){this.mMessagesQueue=[];var l=this;var e=function(q){setTimeout(function(){var i=l.mMessagesQueue[q++];i.sendFunction(i.message);ISQ.Widget.Log.add("chat message sent");if(q!==l.mMessagesQueue.length){e(q)}else{l.mMessagesQueue=null}},20)};e(0)}if(c.length<=ISQ.Widget.iChat.LINE_MAX_LENGTH){this.mMessagesQueue.push({message:j,sendFunction:o})}else{var p=0,d=ISQ.Widget.iChat.LINE_MAX_LENGTH;var g=-1;while(d<c.length){d=Math.min(c.length,p+ISQ.Widget.iChat.LINE_MAX_LENGTH);if(d!==c.length){var h=-1;var b=0;for(var f=0;f<ISQ.Widget.iChat.END_SENTENCE_MARKS.length;f++){var a=ISQ.Data.getURLencodedString(ISQ.Widget.iChat.END_SENTENCE_MARKS[f]);g=c.LastIndexOf(a,d);if(g<p){continue}if(g>h){h=g;b=a.length}}d=h+b}var n=c.substring(p,d);if(n.length>0){var m=ISQ.Data.getURLdecodedString(n);this.mMessagesQueue.push({message:m,sendFunction:o})}p=d}}}};ISQ.Widget.iChat.prototype.sendMessage=function(a){if(!a){return}this.onSendMessage.apply(this,arguments)};ISQ.Widget.iChat.prototype.sendAnswerId=function(a){if(!a.id){return}a.type=ISQ.Widget.iChat.enumMessageType.visitor_id;this.onSendAnswerId.apply(this,arguments)};ISQ.Widget.iChat.prototype.userTyping=function(a){if(!this.inChat()){return}if(a===this.mUserTyping){return}this.mUserTyping=a;this.onUserTyping(a)};ISQ.Widget.iChat.prototype.requestChat=function(a){if(!a&&this.resumingChat()){this.mState|=ISQ.Widget.iChat.enumState.requestingChat;this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.requestingChat);this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.resumingChat);return true}else{if(!a&&this.inChat()){this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.inChat);return true}else{if(!this.available()){this.hChatAvailableChanged.handle(false);return true}this.mState|=ISQ.Widget.iChat.enumState.userActive;this.mState|=ISQ.Widget.iChat.enumState.requestingChat;if(this.mChatSurvey){this.mChatSurvey.dispose()}return this.onRequestChat(a)}}};ISQ.Widget.iChat.prototype.getAvailabilityPerAnswer=function(a){return false
};ISQ.Widget.iChat.prototype.setChatNotActive=function(){this.mActive=false};ISQ.Widget.iChat.prototype.endChat=function(){this.deleteChatFromResume();if((this.mState&~ISQ.Widget.iChat.enumState.userActive)<ISQ.Widget.iChat.enumState.requestingChat){return}if(this.inChat()&&this.mConfig.postChat){this.showPostChat()}this.mState&=~ISQ.Widget.iChat.enumState.chat;this.mState&=~ISQ.Widget.iChat.enumState.resumeChat;this.mState&=~ISQ.Widget.iChat.enumState.requestingChat;this.mPendingMessages=null;this.onEndChat()};ISQ.Widget.iChat.prototype.aboutToResumeChat=function(){this.mState|=ISQ.Widget.iChat.enumState.resumeChat;this.mState|=ISQ.Widget.iChat.enumState.available;this.hResumingChat.handle()};ISQ.Widget.iChat.prototype.chatStarted=function(){if(!this.mActive){return}this.mState|=ISQ.Widget.iChat.enumState.chat;this.mState&=~ISQ.Widget.iChat.enumState.requestingChat;this.onChatStarted.apply(this,arguments);this.hChatStarted.handle();if(this.mPendingMessages){for(var a=0;a<this.mPendingMessages.length;++a){if(this.mPendingMessages[a].type===ISQ.Widget.iChat.enumMessageType.visitor_id){this.sendAnswerId(this.mPendingMessages[a])}else{this.sendMessage(this.mPendingMessages[a].text)}}this.mPendingMessages=null}this.saveChatForResume()};ISQ.Widget.iChat.prototype.connectionError=function(){this.mState&=~ISQ.Widget.iChat.enumState.chat;this.mState&=~ISQ.Widget.iChat.enumState.requestingChat;this.mState&=~ISQ.Widget.iChat.enumState.resumeChat;this.mState&=~ISQ.Widget.iChat.enumState.preChat;this.onChatStopped.apply(this,arguments);this.deleteChatFromResume();this.hConnectionError.handle()};ISQ.Widget.iChat.prototype.chatStopped=function(b){var a=(this.mState&ISQ.Widget.iChat.enumState.chat)>0;if(!a){return}this.mState&=~ISQ.Widget.iChat.enumState.requestingChat;this.mPendingSessionKey=null;this.onChatStopped.apply(this,arguments);this.deleteChatFromResume();if(this.resumingChat()){this.mState&=~ISQ.Widget.iChat.enumState.available;this.mState&=~ISQ.Widget.iChat.enumState.resumeChat}this.hChatEnded.handle.apply(this.hChatEnded,arguments)
};ISQ.Widget.iChat.prototype.chatError=function(){if(!this.inChat()){return}this.mState|=~ISQ.Widget.iChat.enumState.chat;this.mState&=~ISQ.Widget.iChat.enumState.requestingChat;this.onChatError.apply(this,arguments);if(this.resumingChat()){this.mState&=~ISQ.Widget.iChat.enumState.available;this.mState&=~ISQ.Widget.iChat.enumState.resumeChat}this.hChatEnded.handle.apply(this.hChatEnded,arguments)};ISQ.Widget.iChat.prototype.agentTyping=function(a){this.hAgentTyping.handle(a)};ISQ.Widget.iChat.prototype.saveChatForResume=function(){var a=this.getDataToSave();if(!a){return}_session().saveSessionForResume(a,false);clearTimeout(this.mCookieTimer);var b=this;this.mCookieTimer=setTimeout(function(){_session().saveSessionForResume(a,false);b.mCookieTimer=setTimeout(arguments.callee,10*1000)},10*1000)};ISQ.Widget.iChat.prototype.deleteChatFromResume=function(){clearTimeout(this.mCookieTimer);_session().deleteSessionFromResume();ISQ.Widget.CDC.sendMessage("subject=chatEnded")};ISQ.Widget.iChat.prototype.getChatToResume=function(){var b=_session().restoreSession();if(!b.result){return null}return b;var a=ISQ.Tools.Storage.get(ISQ.Widget.iChat.chatCookieName,true);if(!a){a=ISQ.Http.Cookies._read(ISQ.Widget.iChat.chatCookieName);if(a){a=unescape(a)}}if(!a){return null}ISQ.Tools.Storage.remove(ISQ.Widget.iChat.chatCookieName,true);ISQ.Http.Cookies._delete(ISQ.Widget.iChat.chatCookieName,"/widget",ISQ.Http.domain())};ISQ.Widget.iChat.prototype.available=function(){return(this.mState&ISQ.Widget.iChat.enumState.available)==ISQ.Widget.iChat.enumState.available};ISQ.Widget.iChat.prototype.beforeChatAvailableChanged=function(a){a=a===true;if(this.available()===a){return}if(this.hChatAvailableChanged){this.hChatAvailableChanged.handle(a)}};ISQ.Widget.iChat.prototype.inPreChat=function(){return(this.mState&ISQ.Widget.iChat.enumState.preChat)==ISQ.Widget.iChat.enumState.preChat};ISQ.Widget.iChat.prototype.resumingChat=function(){return(this.mState&ISQ.Widget.iChat.enumState.resumeChat)==ISQ.Widget.iChat.enumState.resumeChat};ISQ.Widget.iChat.prototype.inChat=function(){return(this.mState&ISQ.Widget.iChat.enumState.chat)==ISQ.Widget.iChat.enumState.chat
};ISQ.Widget.iChat.prototype.requestingChat=function(){return(this.mState&ISQ.Widget.iChat.enumState.requestingChat)==ISQ.Widget.iChat.enumState.requestingChat};ISQ.Widget.iChat.prototype.userActive=function(){return(this.mState&ISQ.Widget.iChat.enumState.userActive)==ISQ.Widget.iChat.enumState.userActive};ISQ.Widget.iChat.prototype.pendingMessages=function(){return this.mPendingMessages};ISQ.Widget.iChat.prototype.setVisitorId=function(){};ISQ.Widget.iChat.prototype.mActive=true;ISQ.Widget.iChat.prototype.hChatStarted=null;ISQ.Widget.iChat.prototype.hChatEnded=null;ISQ.Widget.iChat.prototype.hIncomingMessage=null;ISQ.Widget.iChat.prototype.hAgentTyping=null;ISQ.Widget.iChat.prototype.hResumingChat=null;ISQ.Widget.iChat.prototype.hChatRequested=null;ISQ.Widget.iChat.prototype.hChatAvailableChanged=null;ISQ.Widget.iChat.prototype.hConnectionError=null;ISQ.Widget.iChat.prototype.handleCDCMessage=function(a){};ISQ.Widget.iChat.prototype.mConfig=null;ISQ.Widget.iChat.prototype.mState=ISQ.Widget.iChat.enumState.init;ISQ.Widget.iChat.prototype.mPendingMessages=null;ISQ.Widget.iChat.prototype.mMessagesQueue=null;ISQ.Widget.iChat.prototype.mChatSurvey=null;ISQ.Widget.iChat.prototype.mUserTyping=false;ISQ.Widget.iChat.prototype.mCookieTimer=null;ISQ.Widget.iChat.ChatSurvey=ISQ.Base.extend({name:"ISQ.Widget.iChat.ChatSurvey",abstractClass:true});ISQ.Widget.iChat.ChatSurvey.abstractClass.onSubmit;ISQ.Widget.iChat.ChatSurvey.abstractClass.onBuild;ISQ.Widget.iChat.ChatSurvey.abstractClass.init;ISQ.Widget.iChat.ChatSurvey.abstractClass.onSurveyFinished;ISQ.Widget.iChat.ChatSurvey.prototype.ctor=function(){ISQ.Widget.Query.hidePopularSuggestions(_("chatSuggestions"));ISQ.Widget.Query.hidePopularSuggestions(_("searchSuggestions"))};ISQ.Widget.iChat.ChatSurvey.prototype.dtor=function(){_("actionBarChatSurvey").style.display="none"};ISQ.Widget.iChat.ChatSurvey.prototype.setChatState=function(a){switch(a){case"pre":ISQ.Widget.iChat.instance.mState|=ISQ.Widget.iChat.enumState.preChat;break}};ISQ.Widget.iChat.ChatSurvey.prototype.build=function(a){ISQ.Widget.Chat.prepereSurveyPane();
this.showLoadingAnim(ISQ.Widget.HTML.chatPane);this.onBuild(a,ISQ.Widget.HTML.chatPane)};ISQ.Widget.iChat.ChatSurvey.prototype.showSurvey=function(a){this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);this.mLoadingAnimation.dispose();this.mSurveyContainer=a;a.style.direction=ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage]["dir"];_("chatSurveySubmitButton").innerHTML=ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage]["sendBtn"];_("chatSurveyCloseButton").innerHTML=ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage]["cancel"];ISQ.Widget.HTML.fixContentWidths();var b=function(){_("actionBarChatSurvey").style.display="block";_("actionBarQuery").style.display="none";ISQ.Widget.HTML.dynamicSize_sendMessage()};if(ISQ.Widget.HTML.canPerformFade(this.mSurveyContainer)){if(this.mFader===null){this.mFader=new VisualEffects.Fade(this.mSurveyContainer);this.mFader.fadeInEvent.addHandler(b)}this.mFader.setOpacity(0);this.mFader.fadeIn(200,true)}else{b()}};ISQ.Widget.iChat.ChatSurvey.prototype.surveyCanceled=function(){ISQ.Widget.Chat.endChat(this.mState,true);this.dispose()};ISQ.Widget.iChat.ChatSurvey.prototype.surveyFinished=function(){this.onSurveyFinished();this.dispose()};ISQ.Widget.iChat.ChatSurvey.prototype.submitSurvey=function(){this.showLoadingAnim(clearNode(_("blockerContent")));_("widgetBlocker").style.display="block";if(ISQ.Http.browser.isIE7||ISQ.Http.browser.isIE6){_("widgetBlocker").style.height=ISQ.Widget.HTML.contentWrapper.offsetHeight}if(!this.onSubmit()){_("widgetBlocker").style.display="none";this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);this.mLoadingAnimation.dispose()}};ISQ.Widget.iChat.ChatSurvey.prototype.submitSurveySuccess=function(c,a,b){_("widgetBlocker").style.display="none";if(this.mLoadingAnimation.animDiv){this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);this.mLoadingAnimation.dispose()}this.closeSurvey(c,b)};ISQ.Widget.iChat.ChatSurvey.prototype.submitSurveyError=function(a){_("widgetBlocker").style.display="none";
if(this.mLoadingAnimation.animDiv){this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);this.mLoadingAnimation.dispose()}this.surveyCanceled()};ISQ.Widget.iChat.ChatSurvey.prototype.closeSurvey=function(b,d){var a=null;var c=this;if((ISQ.Widget.iChat.instance.mState&ISQ.Widget.iChat.enumState.preChat)==ISQ.Widget.iChat.enumState.preChat){a=function(){if(b){c.surveyFinished()}else{c.surveyCanceled()}ISQ.Widget.iChat.instance.mState&=~ISQ.Widget.iChat.enumState.preChat}}else{a=function(){c.surveyFinished()}}if(!d&&ISQ.Widget.HTML.canPerformFade(this.mSurveyContainer)){this.mFader.fadeOutEvent.clear();this.mFader.fadeOutEvent.addHandler(a);this.mFader.fadeOut(100)}else{a()}};ISQ.Widget.iChat.ChatSurvey.prototype.showLoadingAnim=function(c){var a=createDiv(c,".surveyLoading");var b=createDiv(a,"float:left;").innerHTML="Please wait...";this.mLoadingAnimation=new ISQ.GUI.ProgressAnimation({container:createDiv(a,".searchAnim &float:left;")});this.mLoadingAnimation.show();this.mLoadingAnimation.animDiv=a};ISQ.Widget.iChat.ChatSurvey.prototype.mLoadingAnimation=null;ISQ.Widget.iChat.ChatSurvey.prototype.mSurveyContainer=null;ISQ.Widget.iChat.ChatSurvey.prototype.mFader=null;