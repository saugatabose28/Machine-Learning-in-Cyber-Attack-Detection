ISQ.Translation=initializeNS("ISQ.Translation");ISQ.Translation.Infra={};ISQ.Translation.Infra.htmlDelimiter="<br/>";ISQ.Translation.Infra.arrayDelimiter=["<hr/>","<nanorep>",'<span class="notranslate"></span>'];ISQ.Translation.Infra.jobIdMarkerTag="idmarker";ISQ.Translation.Infra.contentTypeEnum={TEXT:0,HTML:1};ISQ.Translation.Infra.jobActionEnum={API_TRANSLATE:0};ISQ.Translation.Infra.workQueue;ISQ.Translation.Infra.slots;ISQ.Translation.Infra.enabled=true;ISQ.Translation.Infra.currentLanguageDetector=null;ISQ.Translation.Infra.detectorCounts=0;ISQ.Translation.Infra.lastJobId=0;ISQ.Translation.Infra.requestRetries=0;ISQ.Translation.Infra.canceledBatches=new Array();ISQ.Translation.Infra.providerEnum={GoogleV1:0,Microsoft:1,GoogleV2:2};ISQ.Translation.Infra.maxRequestCharacters=[1300,1300,1800];ISQ.Translation.Infra.provider=ISQ.Http.browser.isIE11?ISQ.Translation.Infra.providerEnum.Microsoft:ISQ.Translation.Infra.providerEnum.GoogleV2;ISQ.Translation.Infra.provider=ISQ.Translation.Infra.providerEnum.GoogleV2;ISQ.Translation.Infra.googleApiLoaded=false;ISQ.Translation.Infra.apiKeys=null;ISQ.Translation.Infra.API_KEY_DELIMITER=";";ISQ.Translation.Infra.failureEvent=new ISQ.Event();ISQ.Translation.Infra.failureEnum={TranslationTimeout:0,TranslationApiFallback:1,DetectionTimeout:2,DetectionApiFallback:3,TranslationDead:4};ISQ.Translation.Infra.END_SENTENCE_MARKS=[".","!","?"," ",""];ISQ.Translation.Infra.CONCURRENT_JOBS=3;ISQ.Translation.Infra.MAX_REQUEST_ATTEMPTS=2;ISQ.Translation.Infra.REQUEST_TIMEOUT_MS=5000;ISQ.Translation.Infra.rtlLanguages={iw:true,ar:true,ur:true,yi:true,he:true};ISQ.Translation.Infra.jobStatusEnum={Created:0,Running:1,Canceled:2,Failed:3,TimedOut:4};ISQ.Translation.Infra.Job=ISQ.Base.extend({name:"ISQ.Translation.Infra.Job"});ISQ.Translation.Infra.Job.prototype.ctor=function(a){this.text=a.text;this.htmlTags=a.htmlTags||null;this.handler=a.handler;this.finalHandler=a.finalHandler||null;this.fromLanguage=a.fromLanguage||null;this.toLanguage=a.toLanguage||null;this.contentType=a.contentType||ISQ.Translation.Infra.contentTypeEnum.TEXT;
this.tag=isNaN(a.tag)?null:a.tag;this.action=a.action||ISQ.Translation.Infra.jobActionEnum.API_TRANSLATE;this.provider=a.provider||null;this.batchId=a.batchId;this.id=++ISQ.Translation.Infra.lastJobId;this.status=ISQ.Translation.Infra.jobStatusEnum.Created};ISQ.Translation.Infra.Job.prototype.dtor=function(){};ISQ.Translation.Infra.Job.prototype.clone=function(){var c=ISQ.Translation.Infra.extractJobIdFromText(this.text);var a=c.text;var b={text:a,htmlTags:this.htmlTags,handler:this.handler?new ISQ.Handler(this.handler.func,this.handler.context):null,finalHandler:this.finalHandler?new ISQ.Handler(this.finalHandler.func,this.finalHandler.context):null,fromLanguage:this.fromLanguage,toLanguage:this.toLanguage,contentType:this.contentType,tag:this.tag,action:this.action,provider:this.provider,batchId:this.batchId,status:this.status};return new ISQ.Translation.Infra.Job(b)};ISQ.Translation.Infra.Job.prototype.text=null;ISQ.Translation.Infra.Job.prototype.htmlTags=null;ISQ.Translation.Infra.Job.prototype.handler=null;ISQ.Translation.Infra.Job.prototype.finalHandler=null;ISQ.Translation.Infra.Job.prototype.fromLanguage=null;ISQ.Translation.Infra.Job.prototype.toLanguage=null;ISQ.Translation.Infra.Job.prototype.contentType=null;ISQ.Translation.Infra.Job.prototype.tag=null;ISQ.Translation.Infra.Job.prototype.action=null;ISQ.Translation.Infra.Job.prototype.id=null;ISQ.Translation.Infra.Job.prototype.status=null;ISQ.Translation.Infra.Job.prototype.provider=null;ISQ.Translation.Infra.Job.prototype.timer=null;ISQ.Translation.Infra.Job.prototype.batchId=null;ISQ.Translation.Infra.Slot=ISQ.Base.extend({name:"ISQ.Translation.Infra.Slot"});ISQ.Translation.Infra.Slot.prototype.ctor=function(a){this.id=a};ISQ.Translation.Infra.Slot.prototype.dtor=function(){};ISQ.Translation.Infra.Slot.prototype.getJob=function(){return this.mJob};ISQ.Translation.Infra.Slot.prototype.setJob=function(a){this.mJob=a};ISQ.Translation.Infra.Slot.prototype.id=null;ISQ.Translation.Infra.Slot.prototype.mJob=null;ISQ.Translation.Infra.Splitter=ISQ.Base.extend({name:"ISQ.Translation.Infra.Splitter"});
ISQ.Translation.Infra.Splitter.prototype.ctor=function(a){this.segments=a.segments;this.htmlTags=a.htmlTags;this.handler=a.handler;this.fromLanguage=a.fromLanguage||null;this.toLanguage=a.toLanguage||null;this.contentType=a.contentType||ISQ.Translation.Infra.contentTypeEnum.TEXT;this.translatedTexts=new Array();this.batchId=a.batchId};ISQ.Translation.Infra.Splitter.prototype.dtor=function(){};ISQ.Translation.Infra.Splitter.prototype.translateSegments=function(){for(var b=0;b<this.segments.length;b++){var a=new ISQ.Handler(this.translateSegmentsCallback,this);var c=new ISQ.Translation.Infra.Job({text:this.segments[b],contentType:ISQ.Translation.Infra.contentTypeEnum.TEXT,fromLanguage:this.fromLanguage,toLanguage:this.toLanguage,handler:a,tag:b,batchId:this.batchId});ISQ.Translation.Infra.enqueueAndProcess(c)}};ISQ.Translation.Infra.Splitter.prototype.translateSegmentsCallback=function(f,c){var b=c.tag;this.translatedTexts[b]=f;if(++this.mCounter<this.segments.length){return}var e=this.translatedTexts.join(" ");if(this.contentType==ISQ.Translation.Infra.contentTypeEnum.HTML){if(e.indexOf(ISQ.Translation.Infra.htmlDelimiter)===-1){var d;var a=ISQ.Translation.Infra.htmlDelimiter.replace(/\//g,"");d=new RegExp(a,"gi");e=e.replace(d,ISQ.Translation.Infra.htmlDelimiter)}e=ISQ.Translation.Infra.unifyTagsAndText(this.htmlTags,e)}this.handler.handle(e)};ISQ.Translation.Infra.Splitter.prototype.segments=null;ISQ.Translation.Infra.Splitter.prototype.htmlTags=null;ISQ.Translation.Infra.Splitter.prototype.translatedTexts=null;ISQ.Translation.Infra.Splitter.prototype.handler=null;ISQ.Translation.Infra.Splitter.prototype.fromLanguage=null;ISQ.Translation.Infra.Splitter.prototype.toLanguage=null;ISQ.Translation.Infra.Splitter.prototype.contentType=null;ISQ.Translation.Infra.Splitter.prototype.mCounter=0;ISQ.Translation.Infra.Splitter.prototype.batchId=null;ISQ.Translation.Infra.Detector=ISQ.Base.extend({name:"ISQ.Translation.Infra.Detector"});ISQ.Translation.Infra.Detector.prototype.ctor=function(a){if(!a.string||a.string.length==0||a.string.length>ISQ.Translation.Infra.getMaxRequestCharacters()){throw ("ISQ.Translation.Infra.Detector.ctor: the string must not be empty and its length must be less than "+ISQ.Translation.Infra.getMaxRequestCharacters())
}if(ISQ.Translation.Infra.currentLanguageDetector){ISQ.Translation.Infra.currentLanguageDetector.dispose()}ISQ.Translation.Infra.currentLanguageDetector=this;this.handler=a.handler;this.requestId=ISQ.Translation.Infra.detectorCounts++;this.string=a.string;this.provider=ISQ.Translation.Infra.provider;this.detect()};ISQ.Translation.Infra.Detector.prototype.dtor=function(){clearTimeout(this.timer);if(!this.keepWindowFunction&&window["detectFunc"+this.requestId]){window["detectFunc"+this.requestId]=null}if(ISQ.Translation.Infra.currentLanguageDetector===this){ISQ.Translation.Infra.currentLanguageDetector=null}};ISQ.Translation.Infra.Detector.prototype.clone=function(){return{handler:this.handler?new ISQ.Handler(this.handler.func,this.handler.context):null,string:this.string,provider:this.provider}};ISQ.Translation.Infra.Detector.prototype.handler=null;ISQ.Translation.Infra.Detector.prototype.requestId=null;ISQ.Translation.Infra.Detector.prototype.provider=null;ISQ.Translation.Infra.Detector.prototype.timer=null;ISQ.Translation.Infra.Detector.prototype.keepWindowFunction=false;ISQ.Translation.Infra.Detector.prototype.detect=function(){var a=this;var b=a.requestId;this.timer=setTimeout(function(){ISQ.Translation.Infra.Detector.timedOut(a)},ISQ.Translation.Infra.REQUEST_TIMEOUT_MS);window["detectFunc"+a.requestId]=function(g){clearTimeout(a.timer);if(a!==ISQ.Translation.Infra.currentLanguageDetector){return}var f,e;if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV2){if(g.data){f=g.data["detections"][0][0]["language"];e=g.data["detections"][0][0]["confidence"];if(e==="NaN"||e<=0.025){f=null}}else{if(g.error){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.Detector.detect error: "+g.error["errors"][0].domain+" "+g.error["errors"][0].reason+" "+g.error["errors"][0].message,ISQ.Widget.Log.statusEnum.RED)}ISQ.Translation.Infra.Detector.fallbackApiProvider(a);return}}}else{f=g}if(a.handler){a.handler.handle(f)}if(!a.isDisposed()){a.keepWindowFunction=false;a.dispose()}else{window["detectFunc"+b]=null
}};if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV1&&!ISQ.Translation.Infra.googleApiLoaded){ISQ.Translation.Infra.Detector.fallbackApiProvider(this);return}this.keepWindowFunction=true;if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV2){var d=new Array();d.push("https://www.googleapis.com/language/translate/v2/detect?callback=detectFunc");d.push(this.requestId);d.push("&key=");d.push(ISQ.Translation.Infra.apiKeys.GoogleV2);d.push("&q=");var c;if(ISQ.Http.browser.isIE11){c=encodeURI(this.string)}else{if(this.string.contains("&")){c=this.string.replace(/&/g,"%26")}else{c=this.string}}d.push(c);ISQ.Tools.appendScript(d)}else{if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV1){google.language.detect(this.string,function(e){if(e.error){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.Detector.detect error: "+e.error.message)}if(a.handler){a.handler.handle(null)}return}if(window["detectFunc"+a.requestId]){window["detectFunc"+a.requestId](e.language)}})}else{var d=new Array();d.push(location.protocol=="https:"?"https":"http");d.push("://api.microsofttranslator.com/V2/Ajax.svc/Detect?oncomplete=detectFunc");d.push(this.requestId);d.push("&appId=");d.push(ISQ.Translation.Infra.apiKeys.Microsoft);d.push("&text=");var c;if(this.string.contains("&")){c=this.string.replace(/&/g,"%26")}else{c=this.string}d.push(c);ISQ.Tools.appendScript(d)}}};ISQ.Translation.Infra.Detector.timedOut=function(b){if(b.provider!==ISQ.Translation.Infra.provider){return}if(++ISQ.Translation.Infra.requestRetries<=ISQ.Translation.Infra.MAX_REQUEST_ATTEMPTS){if(ISQ.Translation.Infra.requestRetries==1){ISQ.Translation.Infra.failureEvent.dispatch(ISQ.Translation.Infra.failureEnum.DetectionTimeout,ISQ.Translation.Infra.provider)}var a=b.clone();b.dispose();new ISQ.Translation.Infra.Detector(a);return}ISQ.Translation.Infra.Detector.fallbackApiProvider(b)};ISQ.Translation.Infra.Detector.fallbackApiProvider=function(b){if(!ISQ.Translation.Infra.enabled){return
}if(ISQ.Translation.Infra.provider>0){ISQ.Translation.Infra.provider--;ISQ.Translation.Infra.requestRetries=0;ISQ.Translation.Infra.failureEvent.dispatch(ISQ.Translation.Infra.failureEnum.DetectionApiFallback,ISQ.Translation.Infra.provider);if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("falling back API provider",ISQ.Widget.Log.statusEnum.RED)}var a=b.clone();b.dispose(true);new ISQ.Translation.Infra.Detector(a);return}ISQ.Translation.Infra.enabled=false;ISQ.Translation.Infra.failureEvent.dispatch(ISQ.Translation.Infra.failureEnum.TranslationDead);if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.Detector: Translation is completely dead",ISQ.Widget.Log.statusEnum.RED)}if(b.handler){b.handler.handle(null)}};ISQ.Translation.Infra.init=function(a){if(!a||!a.Microsoft||!a.GoogleV1){throw ("init: Invalid API keys provided.")}ISQ.Translation.Infra.apiKeys=a;ISQ.Translation.Infra.workQueue=new ISQ.Infra.Queue();ISQ.Translation.Infra.slots=new Array();for(var b=0;b<ISQ.Translation.Infra.CONCURRENT_JOBS;b++){var c=new ISQ.Translation.Infra.Slot(b);ISQ.Translation.Infra.slots.push(c)}if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV1){var d=new Array();d.push("https://www.google.com/jsapi?key=");d.push(ISQ.Translation.Infra.apiKeys.GoogleV1);d.push("&callback=ISQ.Translation.Infra.googleApiLoadedCallback");ISQ.Tools.appendScript(d)}};ISQ.Translation.Infra.translate=function(i,c,k,d,b,a){if(!ISQ.Base.isDerivedOf(d,ISQ.Handler)){throw ("ISQ.Translation.Infra.translate: invalid handler")}if(!k||k.length==0){throw ("ISQ.Translation.Infra.translate: toLanguage cannot be empty")}if(!i||i.length==0){return}if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.translate: adding to translation: "+i.substring(0,20),ISQ.Widget.Log.statusEnum.GREEN)}var e=new Array();if(b==ISQ.Translation.Infra.contentTypeEnum.HTML){var j=new Array();ISQ.Translation.Infra.stripHtmlIntoTagsAndText(i,e,j);i=j.join("")}if(ISQ.Data.getURLencodedString(i).length>ISQ.Translation.Infra.getMaxRequestCharacters()){var g=ISQ.Translation.Infra.splitTextToSegments(i);
var h=new ISQ.Translation.Infra.Splitter({segments:g,htmlTags:e,contentType:b,fromLanguage:c,toLanguage:k,handler:d,batchId:a||null});h.translateSegments();return}var f=new ISQ.Translation.Infra.Job({text:i,htmlTags:e,contentType:b,fromLanguage:c,toLanguage:k,handler:d,batchId:a||null});ISQ.Translation.Infra.enqueueAndProcess(f)};ISQ.Translation.Infra.translationCallback=function(i){var f;if(i.error){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.performTranslation error: "+i.error["errors"][0].message,ISQ.Widget.Log.statusEnum.RED)}ISQ.Translation.Infra.fallbackApiProvider();return}if(i.data){f=i.data["translations"][0]["translatedText"]}else{f=i}var j=ISQ.Translation.Infra.extractJobIdFromText(f);var c=j.id;var l=j.text;var e=ISQ.Translation.Infra.getJobAndSlotById(c);if(e===null){return}var d=e.job;var k=e.slot;clearTimeout(d.timer);if(d.action==ISQ.Translation.Infra.jobActionEnum.API_TRANSLATE&&d.contentType==ISQ.Translation.Infra.contentTypeEnum.HTML){l=ISQ.Translation.Infra.unifyTagsAndText(d.htmlTags,l)}else{var g=l;l=ISQ.Data.htmlDecode(l);var a=ISQ.Translation.Infra.arrayDelimiter[this.provider];if(g.indexOf(a)>-1&&l.indexOf(a)==-1){var b=ISQ.Data.htmlDecode(a);var h=new RegExp(b,"g");l=l.replace(h,a)}}k.setJob(null);if(d.status==ISQ.Translation.Infra.jobStatusEnum.Running){d.handler.handle(l,d)}d.dispose();setTimeout(ISQ.Translation.Infra.proccessQueue,0)};ISQ.Translation.Infra.translateArray=function(a,g,j,h,e,b){if(!ISQ.Base.isDerivedOf(h,ISQ.Handler)){throw ("ISQ.Translation.Infra.translate: invalid handler")}if(!j||j.length==0){throw ("ISQ.Translation.Infra.translate: toLanguage cannot be empty")}if(!a||a.length==0){return}var f=ISQ.Translation.Infra.arrayDelimiter[ISQ.Translation.Infra.provider];var c=a.join(f);var i={handler:h,provider:ISQ.Translation.Infra.provider};var d=new ISQ.Handler(ISQ.Translation.Infra.translateArrayCallback,i);ISQ.Translation.Infra.translate(c,g,j,d,e,b)};ISQ.Translation.Infra.translateArrayCallback=function(h,d){var c=this.handler;var f=this.provider;
var a=ISQ.Translation.Infra.arrayDelimiter[f];var b=ISQ.Data.unHTML(a);var g=new RegExp(b,"g");h=h.replace(g,a);var e=h.split(a);c.handle(e)};ISQ.Translation.Infra.performTranslation=function(b){if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV2){var c=new Array();c.push("https://www.googleapis.com/language/translate/v2?callback=ISQ.Translation.Infra.translationCallback");c.push("&key=");c.push(ISQ.Translation.Infra.apiKeys.GoogleV2);if(b.fromLanguage){c.push("&source=");c.push(b.fromLanguage)}c.push("&target=");c.push(b.toLanguage);c.push("&q=");c.push(escape(b.text));ISQ.Tools.appendScript(c)}else{if(ISQ.Translation.Infra.provider===ISQ.Translation.Infra.providerEnum.GoogleV1){var a=b.fromLanguage||"";google.language.translate(b.text,a,b.toLanguage,function(d){if(d.error){if(d.error.message.toLowerCase().indexOf("detect source language")>-1){ISQ.Translation.Infra.translationCallback(b.text);return}if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.performTranslation error: "+d.error.message,ISQ.Widget.Log.statusEnum.RED)}ISQ.Translation.Infra.fallbackApiProvider();return}ISQ.Translation.Infra.translationCallback(d.translation)})}else{var c=new Array();c.push(location.protocol=="https:"?"https":"http");c.push("://api.microsofttranslator.com/V2/Ajax.svc/Translate?oncomplete=ISQ.Translation.Infra.translationCallback&appId=");c.push(ISQ.Translation.Infra.apiKeys.Microsoft);if(b.fromLanguage){c.push("&from=");c.push(ISQ.Translation.Infra.setMicrosoftLangCode(b.fromLanguage))}c.push("&to=");c.push(ISQ.Translation.Infra.setMicrosoftLangCode(b.toLanguage));c.push("&text=");c.push(ISQ.Data.getURLencodedString(b.text));ISQ.Tools.appendScript(c)}}};ISQ.Translation.Infra.proccessQueue=function(){var b=ISQ.Translation.Infra.getFreeSlot();if(!b){return}var a=null;while(true){a=ISQ.Translation.Infra.workQueue.dequeue();if(!a){return}if(ISQ.Translation.Infra.disposeJobIfBatchIsCanceled(a)){continue}break}if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.proccessQueue: found job!",ISQ.Widget.Log.statusEnum.GREEN)
}ISQ.Translation.Infra.addJobIdMarker(a);b.setJob(a);a.timer=setTimeout(function(){ISQ.Translation.Infra.jobTimedOut(a)},ISQ.Translation.Infra.REQUEST_TIMEOUT_MS);a.status=ISQ.Translation.Infra.jobStatusEnum.Running;a.provider=ISQ.Translation.Infra.provider;ISQ.Translation.Infra.performTranslation(a)};ISQ.Translation.Infra.jobTimedOut=function(a){a.status=ISQ.Translation.Infra.jobStatusEnum.TimedOut;if(a.provider!==ISQ.Translation.Infra.provider){return}if(++ISQ.Translation.Infra.requestRetries<=ISQ.Translation.Infra.MAX_REQUEST_ATTEMPTS){var b=ISQ.Translation.Infra.getJobAndSlotById(a.id);var d=b.slot;d.setJob(null);var c=a.clone();a.dispose();if(ISQ.Translation.Infra.requestRetries==1){ISQ.Translation.Infra.failureEvent.dispatch(ISQ.Translation.Infra.failureEnum.TranslationTimeout,ISQ.Translation.Infra.provider)}ISQ.Translation.Infra.enqueueAndProcess(c);return}ISQ.Translation.Infra.fallbackApiProvider()};ISQ.Translation.Infra.fallbackApiProvider=function(){if(!ISQ.Translation.Infra.enabled){return}if(ISQ.Translation.Infra.provider>0){ISQ.Translation.Infra.provider--;ISQ.Translation.Infra.requestRetries=0;if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("falling back API provider",ISQ.Widget.Log.statusEnum.RED)}for(var a=0;a<ISQ.Translation.Infra.CONCURRENT_JOBS;a++){var d=ISQ.Translation.Infra.slots[a];var b=d.getJob();if(!b){continue}var c=b.clone();b.dispose();d.setJob(c);ISQ.Translation.Infra.workQueue.priorityEnqueue(c)}ISQ.Translation.Infra.failureEvent.dispatch(ISQ.Translation.Infra.failureEnum.TranslationApiFallback,ISQ.Translation.Infra.provider);setTimeout(ISQ.Translation.Infra.proccessQueue,0);return}ISQ.Translation.Infra.enabled=false;ISQ.Translation.Infra.failureEvent.dispatch(ISQ.Translation.Infra.failureEnum.TranslationDead);if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra: Translation is completely dead",ISQ.Widget.Log.statusEnum.RED)}};ISQ.Translation.Infra.enqueueAndProcess=function(a){ISQ.Translation.Infra.workQueue.enqueue(a);setTimeout(ISQ.Translation.Infra.proccessQueue,0)
};ISQ.Translation.Infra.addJobIdMarker=function(a){var b=new Array();b.push("<");b.push(ISQ.Translation.Infra.jobIdMarkerTag);b.push(a.id);b.push(">");b.push(a.text);a.text=b.join("")};ISQ.Translation.Infra.extractJobIdFromText=function(k){var d;var g=k.toLowerCase();var j=g.indexOf("<"+ISQ.Translation.Infra.jobIdMarkerTag);if(j===-1){j=g.indexOf("< "+ISQ.Translation.Infra.jobIdMarkerTag)}if(j===-1){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.extractJobIdFromText: Couldnt parse jobIdMarker from text! "+k,ISQ.Widget.Log.statusEnum.RED)}return{id:-1,text:k}}var b=k.indexOf(">",j);if(b===-1){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.extractJobIdFromText: jobIdMarker tag is invalid!",ISQ.Widget.Log.statusEnum.RED)}return{id:-1,text:k}}b+=1;var h=g.substring(j,b);var e=h.indexOf(ISQ.Translation.Infra.jobIdMarkerTag);if(e===-1){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.extractJobIdFromText: jobIdMarker tag is invalid!",ISQ.Widget.Log.statusEnum.RED)}return{id:-1,text:k}}e+=ISQ.Translation.Infra.jobIdMarkerTag.length;var f="";var a;do{if(e>h.length){break}a=h.charAt(e++);if(a.charCodeAt(0)<48||a.charCodeAt(0)>57){break}f+=a}while(true);d=parseInt(f);if(isNaN(d)){if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("ISQ.Translation.Infra.extractJobIdFromText: jobIdMarker tag is invalid: could not parse id#",ISQ.Widget.Log.statusEnum.RED)}return{id:-1,text:k}}var i;if(j===0){i=k.substring(b)}else{i=k.substring(0,j);if(b<k.length){i+=k.substring(b)}}return{id:d,text:i}};ISQ.Translation.Infra.getJobAndSlotById=function(b){for(var a=0;a<ISQ.Translation.Infra.CONCURRENT_JOBS;a++){var d=ISQ.Translation.Infra.slots[a];var c=d.getJob();if(c&&c.id===b){return{job:c,slot:d}}}return null};ISQ.Translation.Infra.getFreeSlot=function(){for(var a=0;a<ISQ.Translation.Infra.CONCURRENT_JOBS;a++){var b=ISQ.Translation.Infra.slots[a];if(b.getJob()==null){return b}}return null};ISQ.Translation.Infra.disposeJobIfBatchIsCanceled=function(a){if(!a||!a.batchId||isNaN(a.batchId)){return false
}var b=a.batchId+"";var c=ISQ.Translation.Infra.canceledBatches[b];if(!c){return false}ISQ.Translation.Infra.canceledBatches[b]=null;delete ISQ.Translation.Infra.canceledBatches[b];if(ISQ.Widget&&ISQ.Widget.Log){ISQ.Widget.Log.add("translations infra: disposing job that was canceled: "+a.text,ISQ.Widget.Log.statusEnum.GREEN)}a.dispose();return true};ISQ.Translation.Infra.addBatchToCancelList=function(a){if(!a||isNaN(a)){return}ISQ.Translation.Infra.canceledBatches[a+""]=true};ISQ.Translation.Infra.splitTextToSegments=function(m){var j=new Array();var b=ISQ.Data.getURLencodedString(m);var g=ISQ.Translation.Infra.getMaxRequestCharacters();if(b.length<=g){j.push(m);return j}var l=0,c=g;var e=-1;while(c<b.length){c=Math.min(b.length,l+g);var f=e;for(var d=0;d<ISQ.Translation.Infra.END_SENTENCE_MARKS.length;d++){var a=ISQ.Data.getURLencodedString(ISQ.Translation.Infra.END_SENTENCE_MARKS[d]);e=b.LastIndexOf(a,c);if(e>f){c=e+a.length;break}}var k=b.substring(l,c);if(k.length>0){var h=ISQ.Data.getURLdecodedString(k);j.push(h)}l=c}return j};ISQ.Translation.Infra.stripHtmlIntoTagsAndText=function(d,j,k){var i=0;var g=d.indexOf("<");if(g===-1){k.push(ISQ.Data.htmlDecode(d));return}var c=-1;var e=0;var f=-1;while(true){if(e!==g){var h=g==-1?d.length:g;if(k.length!==0){k.push(ISQ.Translation.Infra.htmlDelimiter)}k.push(ISQ.Data.htmlDecode(d.substring(e,h)));j.push("{");j.push(i++);j.push("}")}if(g==-1){break}f=g;if(d.substr(g+1,4).toLowerCase()==="code"){var a=g-1;var c=d.indexOf("</code>",a)+7;if(c===-1){e=c=d.length;g=-1}else{e=c;g=d.indexOf("<",e)}var b=d.substring(a+1,c);j.push(b)}else{if(d.substr(g+1,5).toLowerCase()==="style"){var a=g-1;var c=d.indexOf("</style>",a)+8;if(c===-1){e=c=d.length;g=-1}else{e=c;g=d.indexOf("<",e)}var b=d.substring(a+1,c);j.push(b)}else{var c=d.indexOf(">",g+1);if(c===-1){break}j.push(d.substring(g,++c));e=c;g=d.indexOf("<",e)}}}};ISQ.Translation.Infra.unifyTagsAndText=function(d,e){if(!d||d.length==0){return e}var b=d.join("");var c=e.split(ISQ.Translation.Infra.htmlDelimiter);for(var a=0;a<c.length;
a++){b=b.replace("{"+a+"}",ISQ.Data.htmlDecode(c[a]))}return b};ISQ.Translation.Infra.getLanguageDirection=function(a){return ISQ.Translation.Infra.rtlLanguages[a]==null?"ltr":"rtl"};ISQ.Translation.Infra.googleApiLoadedCallback=function(){google.load("language","1",{callback:ISQ.Translation.Infra.googleLanguageLoaded})};ISQ.Translation.Infra.googleLanguageLoaded=function(){ISQ.Translation.Infra.googleApiLoaded=true};ISQ.Translation.Infra.getProviderName=function(a){return ISQ.Tools.getEnumValue(ISQ.Translation.Infra.providerEnum,a)};ISQ.Translation.Infra.getMaxRequestCharacters=function(){return ISQ.Translation.Infra.maxRequestCharacters[ISQ.Translation.Infra.provider]};ISQ.Translation.Infra.MicrosoftLanguageCodes={iw:"he",zh:"zh-CHS"};ISQ.Translation.Infra.setMicrosoftLangCode=function(a){return ISQ.Translation.Infra.MicrosoftLanguageCodes[a]||a};